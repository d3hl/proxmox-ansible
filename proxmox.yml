- name: Prepare proxmox
  hosts: all
  gather_facts: false
  tasks:
    - name: Init
      ansible.builtin.include_role:
        name: 00_init

    - name: Backup etc
      ansible.builtin.include_role:
        name: 01_backup-etc

    - name: Date timezone
      ansible.builtin.include_role:
        name: 02_date-timezone

    - name: Prepare repos
      ansible.builtin.include_role:
        name: 03_prepare-repos

    - name: Run role for init sshd user
      ansible.builtin.include_role:
        name: 04_init-sshd

    - name: Ð¡onfigure-users
      ansible.builtin.include_role:
        name: 05_configure-users

    - name: Configure-bash
      ansible.builtin.include_role:
        name: 06_configure-bash

    - name: Prepare system
      ansible.builtin.include_role:
        name: 07_prepare-system

    - name: Configure-network
      ansible.builtin.include_role:
        name: 08_configure-network

    - name: Configure-zfs
      ansible.builtin.include_role:
        name: 09_configure-zfs

    - name: Configure-proxmox
      ansible.builtin.include_role:
        name: 10_configure-proxmox

    - name: Enable pcie-passthrough
      ansible.builtin.include_role:
        name: 11_pcie-passthrough

    - name: Install software
      ansible.builtin.include_role:
        name: 12_install-software

    - name: Configure ksmtuned
      ansible.builtin.include_role:
        name: 13_ksmtuned

    - name: Ram disk
      ansible.builtin.include_role:
        name: 14_create-ramdisk

    - name: Set cpu performance
      ansible.builtin.include_role:
        name: 15_cpu performance

    - name: Web show temperatures
      ansible.builtin.include_role:
        name: 16_web_temp_sensors

    - name: Kernel pinning
      ansible.builtin.include_role:
        name: 17_pin_kernel

    - name: Fail2ban
      ansible.builtin.include_role:
        name: 18_fail2ban

    - name: Nested virtualization
      ansible.builtin.include_role:
        name: 19_nested_virtualization

    - name: Enable nginx
      ansible.builtin.include_role:
        name: 20_nginx

    - name: Move logs to tmpfs
      ansible.builtin.include_role:
        name: 21_logs_tmpfs

    - name: Update system
      ansible.builtin.include_role:
        name: 99_update_reboot

    # - name: Flush all handlers
    #   ansible.builtin.meta: flush_handlers

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub
      changed_when: false

    - name: Proxmox Boot Tool Refresh
      ansible.builtin.command: proxmox-boot-tool refresh
      changed_when: false
